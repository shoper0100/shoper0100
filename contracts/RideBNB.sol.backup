// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

/**
 * @title SecurityBase
 * @dev Base security features for RideBNB contract
 * Includes reentrancy guard, pausable, and rate limiting
 */
contract SecurityBase {
    
    // ============ SECURITY STATE ============
    
    bool private _locked;  // Reentrancy guard
    bool public paused;    // Pause state
    address public owner;
    
    mapping(uint => uint) public lastActionTime;  // Rate limiting per user
    uint public actionCooldown = 60;  // 60 seconds cooldown (configurable)
    
    // ============ EVENTS ============
    
    event Paused(address indexed by, uint timestamp);
    event Unpaused(address indexed by, uint timestamp);
    event CooldownUpdated(uint oldCooldown, uint newCooldown);
    event EmergencyWithdraw(address indexed to, uint amount);
    
    // ============ MODIFIERS ============
    
    /**
     * @dev Prevents reentrancy attacks
     */
    modifier nonReentrant() {
        require(!_locked, "Reentrant call");
        _locked = true;
        _;
        _locked = false;
    }
    
    /**
     * @dev Prevents execution when contract is paused
     */
    modifier whenNotPaused() {
        require(!paused, "Contract is paused");
        _;
    }
    
    /**
     * @dev Only allows execution when contract is paused
     */
    modifier whenPaused() {
        require(paused, "Contract is not paused");
        _;
    }
    
    /**
     * @dev Only allows contract owner
     */
    modifier onlyOwner() {
        require(msg.sender == owner, "Only owner");
        _;
    }
    
    /**
     * @dev Rate limiting per user
     */
    modifier rateLimit(uint _userId) {
        require(
            block.timestamp >= lastActionTime[_userId] + actionCooldown,
            "Action too frequent"
        );
        _;
        lastActionTime[_userId] = block.timestamp;
    }
    
    // ============ SECURITY FUNCTIONS ============
    
    /**
     * @dev Pause contract - emergency only
     */
    function pause() external onlyOwner whenNotPaused {
        paused = true;
        emit Paused(msg.sender, block.timestamp);
    }
    
    /**
     * @dev Unpause contract
     */
    function unpause() external onlyOwner whenPaused {
        paused = false;
        emit Unpaused(msg.sender, block.timestamp);
    }
    
    /**
     * @dev Update cooldown period
     */
    function setActionCooldown(uint _newCooldown) external onlyOwner {
        require(_newCooldown <= 300, "Max 5 minutes");
        uint oldCooldown = actionCooldown;
        actionCooldown = _newCooldown;
        emit CooldownUpdated(oldCooldown, _newCooldown);
    }
    
    /**
     * @dev Emergency withdraw - only when paused
     */
    function emergencyWithdraw() external onlyOwner whenPaused {
        uint balance = address(this).balance;
        require(balance > 0, "No balance");
        
        payable(owner).transfer(balance);
        emit EmergencyWithdraw(owner, balance);
    }
    
    /**
     * @dev Check if user can perform action (cooldown check)
     */
    function canPerformAction(uint _userId) public view returns(bool) {
        return block.timestamp >= lastActionTime[_userId] + actionCooldown;
    }
}
